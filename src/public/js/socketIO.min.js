const socket = io();

const register = document.querySelector('.register');

register.onclick = () => {
   $('#apellidos').val('');
   $('#nombres').val('');
   $('#telefono').val('');
   $('#numBoleto').val('');
   $('#vendedor option:first').prop('selected', true);

   $('#modalAddBoleto').modal('show');
};

const formAdd = document.querySelector('#formAdd');
const apellidos = document.querySelector('#apellidos');
const nombres = document.querySelector('#nombres');
const telefono = document.querySelector('#telefono');
const numBoleto = document.querySelector('#numBoleto');
const vendedor = document.querySelector('#vendedor');

formAdd.addEventListener('submit', (e) => {
   e.preventDefault();
   
   if (
      apellidos.value === '' ||
      nombres.value === '' ||
      telefono.value === '' ||
      numBoleto.value === '' ||
      vendedor.value === ''
   ) {
      Swal.fire({
         position: 'top-end',
         imageUrl: '/img/BiingSIO.png',
         imageWidth: 100,
         imageHeight: 100,
         imageAlt: 'BiingSIO',
         title: 'CAMPOS VACÍOS',
         html: '<p style="font-size: 1rem; margin-bottom: 0 !important;">Los campos no pueden ir vacíos o con espacios.</p>',
         showConfirmButton: false,
         timer: 1800
      });
   } else {
      socket.emit('client:newboleto', {
         apellidos: $.trim(apellidos.value),
         nombres: $.trim(nombres.value),
         telefono: $.trim(telefono.value),
         numBoleto: $.trim(numBoleto.value),
         vendedor: $.trim(vendedor.value)
      });
   }

   socket.on('server:resp', data => {      
      if (data.msg) {
         Swal.fire({
            title: 'Registro guardado',
            html: '<p style="font-size: 1rem;">La venta del boleto se guardado con éxito...</p>',
            imageUrl: '/img/BiingSIO.png',
            imageWidth: 100,
            imageHeight: 100,
            imageAlt: 'BiingSIO',
            allowOutsideClick: false
         }).then((result) => {            
            if (result.value) {
               $('#modalAddBoleto').modal('hide');
            }
         });
      }
      
      if (!data.msg) {
         Swal.fire({
            title: 'Registro no guardado',
            html: '<p style="font-size: 1rem;">La venta del boleto no se pudo guardar...</p>',
            icon: 'info',
            allowOutsideClick: false
         });
      }

      if (data.msg === 'uso') {
         Swal.fire({
            title: 'Boleto vendido',
            html: '<p style="font-size: 1rem;">El boleto a vender ya ha sido vendido...</p>',
            icon: 'warning',
            allowOutsideClick: false
         });
      }
      
      if (data.msg === 'error') {
         Swal.fire({
            title: 'Problemas',
            html: '<p style="font-size: 1rem;">Opss! Error 500 x_x. ¡Intentelo más luego!...</p>',
            icon: 'error',
            allowOutsideClick: false
         });
      }
   });
});

socket.on('server:gen', data => {
   console.log('Escuchando...');
   let boletoNum;

   if (data) {
      if (data.numBoleto) {
         boletoNum = (data.numBoleto < 10) 
            ? `0${data.numBoleto}` 
            : data.numBoleto;
      }
   
      document.querySelector(`.C${data.numBoleto}`).classList.add('vendido');
      document.querySelector(`.C${data.numBoleto}`).innerHTML = `
         <div class="number">
            ${boletoNum}
         </div>
         
         <div class="vendedor">
         Vendido
         </div>
      `;
   }
});

const searchData = (ID) => {
   socket.emit('client:searchboleto', $.trim(ID));
};

socket.on('server:searchboleto', data => {
   if (!data) {
      Swal.fire({
         position: 'top-end',
         imageUrl: '/img/BiingSIO.png',
         imageWidth: 100,
         imageHeight: 100,
         imageAlt: 'BiingSIO',
         title: 'BOLETO NO VENDIDO',
         html: '<p style="font-size: 1rem; margin-bottom: 0 !important;">El boleto a buscar aun no se ha vendido.</p>',
         showConfirmButton: false,
         timer: 1800
      });
   } else {
      $('#apellidosS').val(`${data.apellidos}`);
      $('#nombresS').val(`${data.nombres}`);
      $('#telefonoS').val(`${data.telefono}`);
      $('#numBoletoS').val(`${data.numBoleto}`);
      $('#vendedorS').val(`${data.vendedor}`);

      $('#modalList').modal('show');
   }
});